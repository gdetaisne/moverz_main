name: Check Content Links (Anti-404)

on:
  pull_request:
    paths:
      - 'sites/*/content/**'
      - 'content/**'
  push:
    branches:
      - main
    paths:
      - 'sites/*/content/**'
      - 'content/**'

jobs:
  check-forbidden-patterns:
    name: Block forbidden link patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for forbidden patterns in diff
        run: |
          echo "üîç Recherche de patterns interdits dans sites/*/content/**..."
          
          # Patterns interdits
          PATTERNS=(
            '](/demenagement/[a-z0-9-]+)'
            '](/blog/[a-z0-9-]+/guide/?)'
          )
          
          # Get diff for sites/*/content/**
          git diff HEAD~1 HEAD -- 'sites/*/content/**' > /tmp/content_diff.txt
          
          ERRORS=0
          for pattern in "${PATTERNS[@]}"; do
            echo "  Checking pattern: $pattern"
            if grep -E "$pattern" /tmp/content_diff.txt; then
              echo "‚ùå ERREUR: Pattern interdit d√©tect√©: $pattern"
              echo "   Ce pattern cause des 404. Utilisez les slugs piliers ville-centr√©s."
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "üö´ COMMIT BLOQU√â"
            echo "   $ERRORS pattern(s) interdit(s) d√©tect√©(s)"
            echo ""
            echo "üìñ Exemples corrects:"
            echo "   ‚ùå /blog/devis/guide"
            echo "   ‚úÖ /blog/devis-demenagement-bordeaux/devis-demenagement-bordeaux-guide"
            echo ""
            echo "   ‚ùå /demenagement/cout-reel-nice"
            echo "   ‚úÖ /blog/satellites/cout-reel-demenagement-nice"
            exit 1
          fi
          
          echo "‚úÖ Aucun pattern interdit d√©tect√©"

  check-internal-links:
    name: Validate internal Markdown links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install markdown-link-check
        run: npm install -g markdown-link-check
      
      - name: Check links in modified files (Nice & Bordeaux priority)
        run: |
          echo "üîç V√©rification des liens internes Markdown..."
          
          # Villes prioritaires pour validation
          CITIES=("nice" "bordeaux")
          
          ERRORS=0
          for city in "${CITIES[@]}"; do
            echo ""
            echo "üìç Checking $city..."
            
            # Find all .md files in sites/<city>/content
            if [ -d "sites/$city/content" ]; then
              find "sites/$city/content" -type f -name '*.md' | while read -r file; do
                # Check only internal links (starting with /)
                # Skip external links, anchors, mailto, tel
                if grep -q '](/[^)]*)' "$file"; then
                  echo "  Checking: $file"
                  
                  # Extract internal links
                  grep -oP '\]\(/[^)]+\)' "$file" | sed 's/\](\///' | sed 's/)$//' | while read -r link; do
                    # Skip anchors, query params for simple check
                    clean_link=$(echo "$link" | cut -d'#' -f1 | cut -d'?' -f1)
                    
                    # Check if target exists (approximate: check if slug in content)
                    if [ -n "$clean_link" ]; then
                      slug=$(basename "$clean_link")
                      if ! find "sites/$city/content" -type f -name "*$slug*.md" | grep -q .; then
                        echo "    ‚ö†Ô∏è  Lien potentiellement cass√©: $link (dans $file)"
                        # Note: on ne fail pas ici car c'est une heuristique
                      fi
                    fi
                  done
                fi
              done
            fi
          done
          
          echo ""
          echo "‚úÖ V√©rification des liens termin√©e"
          echo "   Note: Validation compl√®te en local avec linkinator recommand√©e"

  build-smoke-test:
    name: Build smoke test (Bordeaux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'sites/bordeaux/package-lock.json'
      
      - name: Install dependencies
        working-directory: sites/bordeaux
        run: npm ci
      
      - name: Build Bordeaux
        working-directory: sites/bordeaux
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Success
        run: echo "‚úÖ Build Bordeaux r√©ussi - site OK"

