# ü§ñ MOVERZ - Automatisation de la d√©tection des 404

Ce dossier contient les scripts d'automatisation pour d√©tecter et corriger les erreurs 404 √† partir de Google Analytics 4 et BigQuery.

---

## üìÅ FICHIERS G√âN√âR√âS

| Fichier | Description |
|---------|-------------|
| `ga4-404-monitor.js` | Script Node.js pour GA4 Data API |
| `ga4-404-bigquery.py` | Script Python pour BigQuery + GA4 |
| `env.example.txt` | Template de configuration |
| `.htaccess.redirects` (racine) | Redirections Apache 301 |
| `next.config.redirects.mjs` (racine) | Redirections Next.js |

---

## üöÄ INSTALLATION

### **Option 1 : GA4 Data API (Node.js)**

#### Pr√©requis
- Node.js 18+ 
- Acc√®s √† GA4 Data API
- Service account Google Cloud

#### Installation
\`\`\`bash
cd scripts
npm install @google-analytics/data dotenv
\`\`\`

#### Configuration
\`\`\`bash
# Copier le template de configuration
cp env.example.txt .env

# √âditer .env avec vos credentials
nano .env
\`\`\`

**Variables requises dans `.env` :**
\`\`\`bash
GA4_PROPERTY_ID=properties/123456789
GOOGLE_APPLICATION_CREDENTIALS=./service-account-key.json
\`\`\`

#### Ex√©cution
\`\`\`bash
node ga4-404-monitor.js
\`\`\`

**Sortie :**
- `scripts/reports/ga4-404-report.json` : Rapport complet JSON
- `scripts/reports/next-redirects-auto.mjs` : Code Next.js g√©n√©r√©

---

### **Option 2 : BigQuery (Python)**

#### Pr√©requis
- Python 3.8+
- Export GA4 vers BigQuery activ√©
- Service account avec acc√®s BigQuery

#### Installation
\`\`\`bash
cd scripts
pip install google-cloud-bigquery pandas python-dotenv
\`\`\`

#### Configuration
\`\`\`bash
# Copier le template de configuration
cp env.example.txt .env

# √âditer .env avec vos credentials
nano .env
\`\`\`

**Variables requises dans `.env` :**
\`\`\`bash
BIGQUERY_PROJECT_ID=your-project-id
BIGQUERY_DATASET_ID=analytics_XXXXXXXXX
GOOGLE_APPLICATION_CREDENTIALS=./service-account-key.json
\`\`\`

#### Ex√©cution
\`\`\`bash
python ga4-404-bigquery.py
\`\`\`

**Sortie :**
- `scripts/reports/ga4-404-report-bigquery.json` : Rapport complet JSON
- `scripts/reports/next-redirects-auto-bigquery.mjs` : Code Next.js g√©n√©r√©

---

## üîê CONFIGURATION GOOGLE CLOUD

### 1. Cr√©er un Service Account

1. Acc√©der √† [Google Cloud Console](https://console.cloud.google.com/)
2. Aller dans **IAM & Admin** > **Service Accounts**
3. Cliquer **Create Service Account**
4. Nom : `moverz-ga4-automation`
5. Donner les permissions :
   - **GA4** : Viewer ou Analyst
   - **BigQuery** : BigQuery Data Viewer

### 2. Activer les APIs

\`\`\`bash
# Activer GA4 Data API
gcloud services enable analyticsdata.googleapis.com

# Activer BigQuery API
gcloud services enable bigquery.googleapis.com
\`\`\`

### 3. T√©l√©charger la cl√© JSON

1. Dans Service Accounts, cliquer sur votre service account
2. Onglet **Keys** > **Add Key** > **Create new key**
3. Format : JSON
4. T√©l√©charger et sauvegarder dans `scripts/service-account-key.json`

‚ö†Ô∏è **ATTENTION** : Ne jamais commiter ce fichier dans Git !

\`\`\`bash
# Ajouter √† .gitignore
echo "scripts/service-account-key.json" >> .gitignore
echo "scripts/.env" >> .gitignore
\`\`\`

---

## üìä UTILISATION

### **Ex√©cution manuelle**

\`\`\`bash
# Node.js
cd scripts
node ga4-404-monitor.js

# Python
cd scripts
python ga4-404-bigquery.py
\`\`\`

### **Ex√©cution automatique (cron)**

**Linux/Mac (crontab) :**

\`\`\`bash
# √âditer le cron
crontab -e

# Ajouter cette ligne (tous les lundis √† 9h)
0 9 * * 1 cd /Users/lucie/moverz_main-4/scripts && node ga4-404-monitor.js >> /tmp/moverz-404-cron.log 2>&1
\`\`\`

**Ou avec Python :**
\`\`\`bash
0 9 * * 1 cd /Users/lucie/moverz_main-4/scripts && /usr/bin/python3 ga4-404-bigquery.py >> /tmp/moverz-404-cron.log 2>&1
\`\`\`

**Windows (Task Scheduler) :**

1. Ouvrir **Task Scheduler**
2. Create Basic Task
3. Trigger : Weekly (Monday, 9:00 AM)
4. Action : Start a program
5. Program : `node`
6. Arguments : `C:\\path\\to\\moverz_main-4\\scripts\\ga4-404-monitor.js`

---

## üìà RAPPORTS G√âN√âR√âS

### **Format JSON**

Exemple de rapport (`ga4-404-report.json`) :

\`\`\`json
{
  "generatedAt": "2025-10-22T10:30:00Z",
  "period": "7 derniers jours",
  "threshold": 10,
  "summary": {
    "totalViews": 508,
    "uniquePatterns": 8,
    "recommendationsCount": 5
  },
  "recommendations": [
    {
      "source": "/blog",
      "destination": "/actualites",
      "views": 150,
      "domain": "devis-demenageur-toulousain.fr",
      "priority": "HAUTE",
      "topReferrers": [
        {
          "referrer": "google / organic",
          "views": 90
        }
      ]
    }
  ]
}
\`\`\`

### **Code Next.js auto-g√©n√©r√©**

Fichier : `scripts/reports/next-redirects-auto.mjs`

\`\`\`javascript
export const autoGeneratedRedirects = [
  {
    "source": "/blog",
    "destination": "/actualites",
    "permanent": true
  },
  {
    "source": "/estimation-rapide",
    "destination": "/devis",
    "permanent": true
  }
];
\`\`\`

**Int√©gration :**

\`\`\`javascript
// next.config.mjs
import { autoGeneratedRedirects } from './scripts/reports/next-redirects-auto.mjs';

export default {
  async redirects() {
    return [...autoGeneratedRedirects];
  },
};
\`\`\`

---

## üîß PERSONNALISATION

### **Modifier les mappings de redirections**

**Dans `ga4-404-monitor.js` :**

\`\`\`javascript
const SMART_REDIRECTS = {
  '/blog': '/actualites',
  '/estimation-rapide': '/devis',
  '/inventaire-ia': '/analyse-ia',
  // Ajoutez vos propres mappings ici
  '/ancienne-page': '/nouvelle-page',
};
\`\`\`

**Dans `ga4-404-bigquery.py` :**

\`\`\`python
SMART_REDIRECTS = {
    '/blog': '/actualites',
    '/estimation-rapide': '/devis',
    # Ajoutez vos propres mappings ici
    '/ancienne-page': '/nouvelle-page',
}
\`\`\`

### **Modifier le seuil de d√©tection**

Par d√©faut : **10 vues minimum** pour cr√©er une redirection.

**Dans `.env` :**
\`\`\`bash
THRESHOLD_VIEWS=10  # Modifier selon vos besoins
\`\`\`

### **Modifier la p√©riode d'analyse**

Par d√©faut : **7 jours**.

**Dans le code :**
\`\`\`javascript
// JavaScript
const response = await fetch404Data(analyticsDataClient, 30); // 30 jours

// Python
df = fetch_404_data(client, days_ago=30)  # 30 jours
\`\`\`

---

## üß™ TESTS

### **Tester la connexion GA4**

\`\`\`bash
# Node.js
node -e "import { BetaAnalyticsDataClient } from '@google-analytics/data'; const client = new BetaAnalyticsDataClient(); console.log('‚úÖ Connexion OK');"

# Python
python -c "from google.cloud import bigquery; client = bigquery.Client(); print('‚úÖ Connexion OK')"
\`\`\`

### **Tester avec des donn√©es de test**

Modifier temporairement le seuil :

\`\`\`javascript
const THRESHOLD_VIEWS = 1; // Au lieu de 10
\`\`\`

---

## üêõ D√âPANNAGE

### **Erreur : "Permission denied"**

**Solution :**
- V√©rifier que le service account a les permissions GA4 Viewer
- V√©rifier que `GOOGLE_APPLICATION_CREDENTIALS` pointe vers le bon fichier

### **Erreur : "Property not found"**

**Solution :**
- V√©rifier le format : `GA4_PROPERTY_ID=properties/123456789`
- Trouver votre Property ID dans GA4 Admin > Property Settings

### **Erreur : "Table not found" (BigQuery)**

**Solution :**
- V√©rifier que l'export GA4 ‚Üí BigQuery est activ√©
- V√©rifier le format du dataset : `analytics_XXXXXXXXX`
- Attendre 24h apr√®s l'activation de l'export

### **Aucune donn√©e retourn√©e**

**Solution :**
- V√©rifier que des 404 existent dans GA4
- V√©rifier la p√©riode d'analyse (peut-√™tre trop courte)
- V√©rifier le titre exact : "404: This page could not be found"

---

## üìû SUPPORT

**Documentation officielle :**
- [GA4 Data API](https://developers.google.com/analytics/devguides/reporting/data/v1)
- [BigQuery GA4 Export](https://support.google.com/analytics/answer/9358801)
- [Next.js Redirects](https://nextjs.org/docs/app/api-reference/next-config-js/redirects)

**Contact :**
- Chef de projet : Lucie Stehelin de Taisne
- GitHub : [Votre repo]

---

## üìù CHANGELOG

| Version | Date | Changements |
|---------|------|-------------|
| 1.0.0 | 2025-10-22 | Version initiale |

---

**‚ú® Happy coding!**

